name: Build Android AAB

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build web app
      run: npm run build
    
    - name: Setup Capacitor
      run: |
        npm install -g @capacitor/cli
        npx cap sync android
    
    - name: Setup Keystore
      run: |
        echo "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" | base64 -d > android/app/chaoscrypto.keystore
    
    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew
    
    - name: Build Android App Bundle (AAB)
      run: |
        cd android
        ./gradlew bundleRelease
    
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-aab
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
    
    - name: Build Android APK (for testing)
      run: |
        cd android
        ./gradlew assembleRelease
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-apk
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30
